---
title: "XCulture Analysis"
author: "Rose M. Schneider"
date: "8/5/2018"
output: html_document
---
#Setup
```{r setup, include=FALSE}
rm(list = ls())
require("knitr")
opts_knit$set(root.dir = "~/Documents/Projects/xculture/HK_SLO") #this is specific to RMS, change accordingly
library(tidyverse)
library(magrittr)
library(langcog)
library(lme4)
library(stringr)
library(RColorBrewer)
library(ggthemes)
```

##Load data
###Slovenian
```{r}
#demos
slo.demo <- read.csv('Data/slo_demo.csv')%>%
  mutate(dataset = "SLO")%>%
  select(-X, -X.1)%>%
  filter(SID != "")
#give n
slo.gn <- read.csv("Data/slo_given.csv")%>%
  mutate(dataset = "SLO")%>%
  select(-age)%>%
  filter(SID != "")
#highest count
slo.hc <- read.csv("Data/slo_hc.csv")%>%
  mutate(dataset = "SLO")%>%
  select(-age)%>%
  filter(SID != "")
#sf
slo.sf <- read.csv("Data/slo_sf.csv")%>%
  mutate(dataset = "SLO")%>%
  select(-age)%>%
  filter(SID != "")%>%
  mutate(num_answer = factor(num_answer))%>%
  mutate(mem_check_1 = factor(mem_check_1), 
         mem_check_2 = factor(mem_check_2))
#wcn
slo.wcn <- read.csv("Data/slo_wcn.csv")%>%
  mutate(dataset = "SLO")%>%
  select(-age)%>%
  filter(SID != "")%>%
  mutate(num_answer = factor(num_answer), 
         repeat_1 = factor(repeat_1), 
         repeat_2 = factor(repeat_2))
#wppsi
slo.wppsi <- read.csv("Data/slo_wppsi.csv")%>%
  mutate(dataset = "SLO")%>%
  filter(SID != "")%>%
  select(-age)
```

###Hong Kong 
```{r}
#demos
hk.demo <- read.csv('Data/hk_demo.csv')%>%
  mutate(dataset = "HK")%>%
  filter(SID != "")
#give n
hk.gn <- read.csv("Data/hk_given.csv")%>%
  mutate(dataset = "HK")%>%
  filter(SID != "")%>%
  select(-age)%>%
  mutate(trial = ifelse(trial == "second try", 6, trial))
#highest count
hk.hc <- read.csv("Data/hk_hc.csv")%>%
  mutate(dataset = "HK")%>%
  select(-age, -X, -X.1, -X.2, -X.3, -X.4, -X.5)%>%
  filter(SID != "")%>%
  mutate(last_successful = factor(last_successful))
#sf
hk.sf <- read.csv("Data/hk_sf.csv")%>%
  mutate(dataset = "HK")%>%
  select(-age)%>%
  filter(SID != "")%>%
  mutate(num_answer = factor(num_answer))%>%
  mutate(mem_check_1 = factor(mem_check_1), 
         mem_check_2 = factor(mem_check_2))
#wcn
hk.wcn <- read.csv("Data/hk_wcn.csv")%>%
  mutate(dataset = "HK")%>%
  select(-age)%>%
  filter(SID != "")%>%
  mutate(num_answer = factor(num_answer), 
         repeat_1 = factor(repeat_1), 
         repeat_2 = factor(repeat_2))
#wppsi
hk.wppsi <- read.csv("Data/hk_wppsi.csv")%>%
  mutate(dataset = "HK")%>%
  select(-age)%>%
  filter(SID != "")
```

###Bind these datasets together 
```{r}
#demos
demo.raw <- bind_rows(slo.demo, hk.demo)%>%
  mutate(SID = factor(SID))

#given
given.raw <- bind_rows(slo.gn, hk.gn)%>%
  mutate(SID = factor(SID))

#hc
hc.raw <- bind_rows(slo.hc, hk.hc)%>%
  mutate(SID = factor(SID))

#sf 
sf.raw <- bind_rows(slo.sf, hk.sf)%>%
  mutate(SID = factor(SID))

#wcn
wcn.raw <- bind_rows(slo.wcn, hk.wcn)%>%
  mutate(SID = factor(SID))

#wppsi
wppsi.raw <- bind_rows(slo.wppsi, hk.wppsi)%>%
  mutate(SID = factor(SID))

```


###Spread demographic information to other dataframes
```{r}

```



##Tidy data
To-do RMS: Need to pull sex, experimenter & location into other dfs
###Exclusions
```{r}
##This is a function that checks a dataframe for anyone marked as "excluded", pulls out those participants, and puts them into a dataframe
check_exclusions <- function(df){
    exclusions <- df %>%
      filter(exclude == 1)%>%
      distinct(SID, age, exclude, exclude_reason)
    # 
    # exclusions$task = deparse(substitute(df))
    if (length(exclusions$SID) > 0) {
    return(exclusions)
    } else {
      return("No exclusions")
      return(exclusions)
    }
}

df.list <- list(slo_gn, slo_hc, slo_sf, slo_wcn, slo_wppsi)
list_exclusions <- lapply(df.list, check_exclusions)

#function that pulls out unique SIDs & reasons and puts them into a df
unique_exclusions <- function(list) {
  all_exclusions <- data.frame()
  for(item in list){
    df_item <- as.data.frame(item)
    if(length(df_item$SID) > 0){
      tmp_excl <- df_item %>%
        distinct(SID, age, exclude, exclude_reason)
      all_exclusions <- bind_rows(all_exclusions, tmp_excl)
    }
  }
  return(all_exclusions)
}

all_exclusions <- unique_exclusions(list_exclusions)
SIDs_exclude <- as.vector(unique(all_exclusions$SID))

'%!in%' <- function(x,y)!('%in%'(x,y))

#now actually exclude from every dataset 
#this is a function that removes excluded participants across every data frame
exclude_sub <- function(df){
  df %<>%
    filter(SID %!in% SIDs_exclude)
  return(df)
}

slo_gn.df <- exclude_sub(slo_gn)
slo_hc.df <- exclude_sub(slo_hc)
slo_sf.df <- exclude_sub(slo_hc)
slo_wcn.df <- exclude_sub(slo_hc)
slo_wppsi.df <- exclude_sub(slo_wppsi)
```

To-do RMS: Need to make sure same number of participants and same participants across every df

##Data manipulations
Remove examples from data frames
```{r}
slo_gn.df %<>%
  filter(SID != "Example1")
slo_hc.df %<>%
  filter(SID != "Example1" |
           SID!= "Example2")
```

###Non-numeric answers
To-do RMS: There are non-numeric answers for last successful - I think this would be better served by going through the data, tbh
```{r}

```
###Highest count
Cap IHC and FHC at 140
```{r}
slo_hc.df %<>%
  mutate(initial_highest = ifelse(initial_highest > 140, 140, initial_highest), 
         final_highest = ifelse(final_highest > 140, 140, final_highest))

#histogram of initial and final highest counts for a sanity check
tmp <- slo_hc.df %>%
  distinct(SID, initial_highest, final_highest)
hist(tmp$initial_highest)
hist(tmp$final_highest)
```

##Highest count sanity checks
To-do for RMS
```{r}
hc.check <- slo_hc.df %>%
  group_by(SID)%>%
  filter(last_successful == max(last_successful))%>%
  mutate(hc.check = ifelse(final_highest >= last_successful, TRUE, FALSE))%>%
  filter(hc.check == FALSE)
```

